<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS for styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <title>LightningFS and Isomorphic-git POC</title>
    <style>
        /* Custom styling for repository containers */
        .repo-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-3">LightningFS and Isomorphic-git POC</h1>
        <!-- Static display area -->
        <div id="staticDisplay" class="mt-3">
            <p>Navigate to the static page <a href="admin/index.html">here</a></p>
        </div>
        <!-- MicroCI Widget container -->
        <div id="microci-container"></div>
    </div>

    <!-- Required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@isomorphic-git/lightning-fs/dist/lightning-fs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/isomorphic-git@1.27.0/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/isomorphic-git@1.27.0/http/web/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval/dist/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openpgp@5.11.2/dist/openpgp.min.js"></script>

    <!-- MicroCI library -->
    <script src="microci.js"></script>

    <script>
        // Utility functions and global variables
        const fs = new LightningFS('testfs');
        const pfs = fs.promises;
        const corsProxy = 'https://microci.com';
        const pgpKeyUrl = 'https://gist.githubusercontent.com/coolserge/bd305bd73260b61d06954e7c2a982655/raw/ea467d6644fd848ba355640e7714f89734db9da2/file.pgp';

        // Function to register service worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        reg.addEventListener('updatefound', () => {
                            const installingWorker = reg.installing;
                            console.log('A new service worker is being installed:', installingWorker);
                        });
                        console.log('Registration succeeded. Scope is ' + reg.scope);
                    })
                    .catch(error => {
                        console.log('Registration failed with ' + error);
                    });
            } else {
                console.log('Service workers are not supported in this browser.');
            }
        }

        // Initialize MicroCI Widget
        document.addEventListener('DOMContentLoaded', function() {
            const widget = new MicroCIWidget({
                fs: fs,
                pfs: pfs,
                corsProxy: corsProxy,
                pgpKeyUrl: pgpKeyUrl,
                containerId: 'microci-container'
            });

            widget.initialize().then(() => {
                // Apply Bootstrap classes to widget elements after initialization
                applyOriginalStylesToWidget();
            });
        });

        function applyOriginalStylesToWidget() {
            // Clone control panel
            const clonePanel = document.getElementById('microci-container-clone-panel');
            clonePanel.classList.add('mb-3');
            clonePanel.style.display = 'block';

            // Repository form
            const repoForm = document.getElementById('microci-container-repo-form');
            repoForm.classList.add('form-row', 'align-items-center');

            // Repository URL input
            const repoUrlInput = document.getElementById('microci-container-repo-url');
            repoUrlInput.classList.add('form-control', 'mb-2');
            repoUrlInput.placeholder = "Enter repository URL";
            
            // Wrap input in a div
            const inputWrapper = document.createElement('div');
            inputWrapper.classList.add('col-12', 'col-md-6');
            repoUrlInput.parentNode.insertBefore(inputWrapper, repoUrlInput);
            inputWrapper.appendChild(repoUrlInput);

            // Clone button
            const cloneButton = repoForm.querySelector('button');
            cloneButton.classList.add('btn', 'btn-primary', 'mb-2');
            
            // Wrap button in a div
            const buttonWrapper = document.createElement('div');
            buttonWrapper.classList.add('col-12', 'col-md-6');
            cloneButton.parentNode.insertBefore(buttonWrapper, cloneButton);
            buttonWrapper.appendChild(cloneButton);

            // Message display
            const messageDisplay = document.getElementById('microci-container-message');
            messageDisplay.classList.add('alert', 'alert-warning');

            // Repositories container
            const reposContainer = document.getElementById('microci-container-repos-container');
            reposContainer.classList.add('mt-3');

            // Delete all button container
            const deleteAllContainer = document.getElementById('microci-container-delete-all');
            deleteAllContainer.classList.add('mt-3', 'mb-3');

            // Delete all button
            const deleteAllButton = document.getElementById('microci-container-delete-all-button');
            deleteAllButton.classList.add('btn', 'btn-danger');
            deleteAllButton.textContent = 'Delete All Repos';

            // Apply styles to dynamically created elements
            const repoContainers = document.querySelectorAll('.repo-container');
            repoContainers.forEach(container => {
                container.classList.add('repo-container');
                
                const branchSelect = container.querySelector('select:nth-of-type(1)');
                branchSelect.classList.add('form-control', 'mb-2');

                const commitSelect = container.querySelector('select:nth-of-type(2)');
                commitSelect.classList.add('form-control', 'mb-2');

                const buttonContainer = container.querySelector('div:not([data-directory])');
                buttonContainer.classList.add('btn-group', 'mb-2');

                const fetchButton = buttonContainer.querySelector('button:nth-of-type(1)');
                fetchButton.classList.add('btn', 'btn-info', 'mr-2');
                fetchButton.style.width = '120px';

                const deleteButton = buttonContainer.querySelector('button:nth-of-type(2)');
                deleteButton.classList.add('btn', 'btn-danger');
                deleteButton.style.width = '120px';
            });
        }

        // Initialize
        registerServiceWorker();
    </script>
</body>

</html>