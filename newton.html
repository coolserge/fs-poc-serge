<!DOCTYPE html>
<html>

<head>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <!-- LightningFS and Isomorphic-git scripts-->
    <script src="https://cdn.jsdelivr.net/npm/@isomorphic-git/lightning-fs/dist/lightning-fs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/isomorphic-git@1.25.3/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/isomorphic-git@1.25.3/http/web/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval/dist/umd.js"></script>
    <title>LightningFS and Isomorphic-git POC</title>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-3">LightningFS and Isomorphic-git POC</h1>
        <p>Navigate to the static page <a href="admin/index.html">here</a></p>
        <!-- Bootstrap styled buttons -->
        <button id="cloneBtn" class="btn btn-primary mr-2" style="display: none;">Clone</button>
        <button id="deleteBtn" class="btn btn-danger" style="display: none;">Delete</button>
        <!-- Div to display content -->
        <div id="contentDisplay" class="mt-3"></div>
    </div>
    <script>

        // Register the service worker
        registerServiceWorker();
        // Instantiate a new filesystem
        const fs = new LightningFS('testfs');
        const pfs = fs.promises; // Use promises interface for cleaner async operations

        // Function to check if /foo exists and display content if it does
        async function checkAndDisplayContent() {
            try {
                const stats = await pfs.stat('/foo');
                if (stats.isDirectory()) {
                    // Check if the directory is empty
                    const entries = await pfs.readdir('/foo');
                    if (entries.length > 0) {
                        // Directory is not empty, show Delete button
                        document.getElementById('deleteBtn').style.display = 'inline';
                        // If /foo exists, display the navigational content without cloning
                        const config = await loadNavPageContent();
                        document.getElementById('contentDisplay').innerHTML = config;
                    } else {
                        // Directory is empty, show Clone button
                        document.getElementById('cloneBtn').style.display = 'inline';
                    }
                }
                else {
                    document.getElementById('cloneBtn').style.display = 'inline';
                }
            } catch (err) {
                // /foo does not exist, show Clone button
                document.getElementById('cloneBtn').style.display = 'inline';
                console.log('/foo directory does not exist.');
            }
        }

        // Function to recursively delete all files and directories within a given path
        async function deleteDirectoryContents(path) {
            const entries = await pfs.readdir(path);
            await Promise.all(entries.map(async (entry) => {
                const fullPath = `${path}/${entry}`;
                const stats = await pfs.stat(fullPath);
                if (stats.isDirectory()) {
                    await deleteDirectoryContents(fullPath); // Recurse into subdirectory
                    await pfs.rmdir(fullPath); // Remove the now-empty subdirectory
                } else {
                    await pfs.unlink(fullPath); // Delete file
                }
            }));
        }

        // Updated function to delete /foo directory and clear the content display
        async function deleteRepo() {
            try {
                await deleteDirectoryContents('/foo'); // First, delete all contents
                await pfs.rmdir('/foo'); // Then, remove the now-empty directory
                console.log('/foo directory deleted successfully.');
                document.getElementById('contentDisplay').innerHTML = ''; // Clear the display content
                // Toggle button visibility
                document.getElementById('deleteBtn').style.display = 'none';
                document.getElementById('cloneBtn').style.display = 'inline';
            } catch (err) {
                console.log('Failed to delete /foo directory:', err);
            }
        }


        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        reg.addEventListener('updatefound', () => {
                            const installingWorker = reg.installing;
                            console.log('A new service worker is being installed:', installingWorker);
                        });
                        console.log('Registration succeeded. Scope is ' + reg.scope);
                    })
                    .catch(error => {
                        console.log('Registration failed with ' + error);
                    });
            } else {
                console.log('Service workers are not supported in this browser.');
            }
        }

        // Clone function
        async function cloneRepo() {
            await git.clone({
                fs,
                http: GitHttp,
                dir: '/foo',
                //corsProxy: 'https://cors.isomorphic-git.org',
                corsProxy: 'https://sandstonemountain.com', //added our proxy server
                url: 'https://github.com/coolserge/foo',
                singleBranch: true,
                depth: 1
            });
            const config = await loadNavPageContent();
            console.log(config);
            // Display the navigational HTML content inside the div
            document.getElementById('contentDisplay').innerHTML = config;
            // Toggle button visibility
            document.getElementById('cloneBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'inline';
        };

        async function loadNavPageContent() {
            return new Promise((resolve, reject) => {
                fs.readFile('/foo/navpage.html', 'utf8', function (err, data) {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
        }

        // Attach the event listener to the buttons
        document.getElementById('cloneBtn').addEventListener('click', cloneRepo);
        document.getElementById('deleteBtn').addEventListener('click', deleteRepo);

        // Check if /foo exists and display content on page load
        checkAndDisplayContent();
    </script>
</body>

</html>