<!DOCTYPE html>
<html>
<head>
    <title>Secure Storage</title>
</head>
<body>
    <script>
        console.log("Secure storage iframe loaded");

        // Function to safely send a message to the parent
        function safePostMessage(message, targetOrigin) {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(message, targetOrigin);
            } else {
                console.error("Unable to send message to parent window");
            }
        }

        // localStorage operations
        function setData(origin, dataType, key, value) {
            const storageKey = `${origin}:${dataType}:${key}`;
            localStorage.setItem(storageKey, JSON.stringify(value));
        }

        function getData(origin, dataType, key) {
            const storageKey = `${origin}:${dataType}:${key}`;
            const value = localStorage.getItem(storageKey);
            return value ? JSON.parse(value) : null;
        }

        function deleteData(origin, dataType, key) {
            const storageKey = `${origin}:${dataType}:${key}`;
            localStorage.removeItem(storageKey);
        }

        function listData(origin, dataType) {
            const prefix = `${origin}:${dataType}:`;
            return Object.keys(localStorage)
                .filter(key => key.startsWith(prefix))
                .map(key => key.slice(prefix.length));
        }

        // Function to list all localStorage contents
        function listAllLocalStorage() {
            const allItems = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                allItems[key] = value;
            }
            return allItems;
        }

        // Listen for messages from the parent window
        window.addEventListener('message', async (event) => {
            console.log("Received message. Origin:", event.origin, "Data:", event.data);

            // Handle ping message
            if (event.data.action === 'ping') {
                console.log("Received ping, sending pong");
                event.source.postMessage({ action: 'pong' }, event.origin);
                return;
            }

            // Strictly check for root path
            if (event.data.pathname !== '/') {
                console.error("Unauthorized access attempt from non-root page. Pathname:", event.data.pathname);
                return;
            }

            const { id, action, dataType, key, value } = event.data;
            const origin = event.origin;

            let response = { id, action: `${action}Response`, success: false };

            try {
                switch (action) {
                    case 'set':
                        setData(origin, dataType, key, value);
                        response.success = true;
                        break;
                    case 'get':
                        if (dataType === 'listAll') {
                            response.value = listAllLocalStorage();
                        } else {
                            response.value = getData(origin, dataType, key);
                        }
                        response.success = true;
                        break;
                    case 'delete':
                        deleteData(origin, dataType, key);
                        response.success = true;
                        break;
                    case 'list':
                        response.value = listData(origin, dataType);
                        response.success = true;
                        break;
                    default:
                        throw new Error('Unknown action');
                }
            } catch (error) {
                console.error("Operation error:", error);
                response.error = error.message;
            }

            console.log("Sending response:", response);
            safePostMessage(response, origin);
        });

        console.log("Secure storage (localStorage) initialized and ready");
    </script>
</body>
</html>