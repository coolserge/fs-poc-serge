<!DOCTYPE html>
<html>
<head>
    <title>Secure Storage</title>
</head>
<body>
    <script>
        // Open IndexedDB
        let db;
        const dbName = "SecureStorage";
        const request = indexedDB.open(dbName, 1);
        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.error);
        };
        request.onsuccess = (event) => {
            db = event.target.result;
        };
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            const objectStore = db.createObjectStore("keys", { keyPath: ["origin", "key"] });
        };

        // Function to safely send a message to the parent
        function safePostMessage(message, targetOrigin) {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(message, targetOrigin);
            } else {
                console.error("Unable to send message to parent window");
            }
        }

        // Listen for messages from the parent window
        window.addEventListener('message', async (event) => {
            console.log("Received message. Origin:", event.origin, "Pathname:", event.data.pathname);

            // Strictly check for root path
            if (event.data.pathname !== '/') {
                console.error("Unauthorized access attempt from non-root page. Pathname:", event.data.pathname);
                return;
            }

            const { action, key, value } = event.data;
            const origin = event.origin;

            if (action === 'set') {
                const transaction = db.transaction(["keys"], "readwrite");
                const objectStore = transaction.objectStore("keys");
                const request = objectStore.put({ origin, key, value });
                request.onerror = () => {
                    safePostMessage({ action: 'setResponse', success: false, error: request.error.message }, origin);
                };
                request.onsuccess = () => {
                    safePostMessage({ action: 'setResponse', success: true }, origin);
                };
            } else if (action === 'get') {
                const transaction = db.transaction(["keys"], "readonly");
                const objectStore = transaction.objectStore("keys");
                const request = objectStore.get([origin, key]);
                request.onerror = () => {
                    safePostMessage({ action: 'getResponse', success: false, error: request.error.message }, origin);
                };
                request.onsuccess = () => {
                    safePostMessage({ action: 'getResponse', success: true, value: request.result ? request.result.value : null }, origin);
                };
            }
        });
    </script>
</body>
</html>
