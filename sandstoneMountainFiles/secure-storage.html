<!DOCTYPE html>
<html>
<head>
    <title>Secure Storage</title>
</head>
<body>
    <script>
        // Open IndexedDB
        let db;
        const dbName = "SecureStorage";
        const dbVersion = 1;
        const request = indexedDB.open(dbName, dbVersion);

        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.error);
        };

        request.onsuccess = (event) => {
            db = event.target.result;
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            const objectStore = db.createObjectStore("secureData", { keyPath: ["origin", "dataType", "key"] });
        };

        // Function to safely send a message to the parent
        function safePostMessage(message, targetOrigin) {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(message, targetOrigin);
            } else {
                console.error("Unable to send message to parent window");
            }
        }

        // IndexedDB operations
        async function setData(origin, dataType, key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["secureData"], "readwrite");
                const objectStore = transaction.objectStore("secureData");
                const request = objectStore.put({ origin, dataType, key, value });
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function getData(origin, dataType, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["secureData"], "readonly");
                const objectStore = transaction.objectStore("secureData");
                const request = objectStore.get([origin, dataType, key]);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
            });
        }

        async function deleteData(origin, dataType, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["secureData"], "readwrite");
                const objectStore = transaction.objectStore("secureData");
                const request = objectStore.delete([origin, dataType, key]);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        async function listData(origin, dataType) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["secureData"], "readonly");
                const objectStore = transaction.objectStore("secureData");
                const request = objectStore.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const items = request.result.filter(item => item.origin === origin && item.dataType === dataType);
                    resolve(items.map(item => item.key));
                };
            });
        }

        // Listen for messages from the parent window
        window.addEventListener('message', async (event) => {
            console.log("Received message. Origin:", event.origin, "Data:", event.data);

            // Strictly check for root path
            if (event.data.pathname !== '/') {
                console.error("Unauthorized access attempt from non-root page. Pathname:", event.data.pathname);
                return;
            }

            const { id, action, dataType, key, value } = event.data;
            const origin = event.origin;

            let response = { id, action: `${action}Response`, success: false };

            try {
                switch (action) {
                    case 'set':
                        await setData(origin, dataType, key, value);
                        response.success = true;
                        break;
                    case 'get':
                        response.value = await getData(origin, dataType, key);
                        response.success = true;
                        break;
                    case 'delete':
                        await deleteData(origin, dataType, key);
                        response.success = true;
                        break;
                    case 'list':
                        response.value = await listData(origin, dataType);
                        response.success = true;
                        break;
                    default:
                        throw new Error('Unknown action');
                }
            } catch (error) {
                console.error("Operation error:", error);
                response.error = error.message;
            }

            safePostMessage(response, origin);
        });
    </script>
</body>
</html>